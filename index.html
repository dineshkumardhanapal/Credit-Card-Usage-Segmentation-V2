<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Card Customer Segmentation</title>
    <script src="https://cdn.plotly.com/plotly-latest.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .container { display: flex; gap: 20px; }
        .chart-container { flex: 1; }
        .profile-container { flex: 1; }
        .profile-details { border: 1px solid #ccc; padding: 10px; }
        .error { color: red; }
        .debug { font-size: 12px; color: #666; }
        .fallback { border: 1px solid #ddd; padding: 10px; margin-top: 10px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Credit Card Customer Segmentation</h1>
    <h2>Interactive Dashboard to Explore Customer Personas</h2>

    <div class="container">
        <div class="chart-container">
            <h3>Customer Segments (PCA Visualization)</h3>
            <p>Click on a data point to view the customer's profile.</p>
            <div id="pcaChart"></div>
            <div id="errorMessage" class="error"></div>
            <div id="debugInfo" class="debug"></div>
            <div id="fallbackData" class="fallback" style="display:none;">Fallback Data: <pre id="rawData"></pre></div>
        </div>

        <div class="profile-container">
            <h3>Segment Profile</h3>
            <div class="profile-details">
                <p><strong>Select a Customer</strong></p>
                <p>Click on a point in the chart to see details here.</p>
                <p><strong>Customer ID:</strong> <span id="custId"></span></p>
                <p><strong>Balance:</strong> <span id="balance"></span></p>
                <p><strong>Purchases:</strong> <span id="purchases"></span></p>
                <p><strong>Credit Usage Ratio:</strong> <span id="creditUsage"></span></p>
                <p><strong>Cluster:</strong> <span id="cluster"></span></p>
            </div>
        </div>
    </div>

    <script>
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
        }

        function updateDebug(message) {
            document.getElementById('debugInfo').textContent = message;
        }

        console.log('Script execution started at', new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }));
        updateDebug('Loading CSV...');
        d3.csv('customer_segments_for_dashboard.csv').then(data => {
            updateDebug(`CSV loaded, rows: ${data.length}`);
            console.log('CSV data loaded:', data.length);

            data.forEach(d => {
                d.PC1 = +d.PC1 || 0;
                d.PC2 = +d.PC2 || 0;
                d.Cluster = +d.Cluster || 0;
                d.BALANCE = +d.BALANCE || 0;
                d.PURCHASES = +d.PURCHASES || 0;
                d.CREDIT_USAGE_RATIO = +d.CREDIT_USAGE_RATIO || 0;
            });

            console.log('Sample data:', data.slice(0, 5));
            updateDebug('Data parsed, sample checked in console');

            if (data.length === 0) {
                showError('No data loaded from CSV.');
                return;
            }

            const trace = {
                x: data.map(d => d.PC1),
                y: data.map(d => d.PC2),
                mode: 'markers',
                type: 'scatter',
                text: data.map(d => `ID: ${d.CUST_ID}<br>Balance: $${d.BALANCE.toFixed(2)}<br>Purchases: $${d.PURCHASES.toFixed(2)}<br>Ratio: ${d.CREDIT_USAGE_RATIO.toFixed(2)}`),
                marker: { size: 10, color: data.map(d => d.Cluster), colorscale: 'Viridis' }
            };

            const layout = {
                title: 'Customer Segments (PCA Visualization)',
                xaxis: { title: 'PC1' },
                yaxis: { title: 'PC2' }
            };

            updateDebug('Attempting to render chart...');
            Plotly.newPlot('pcaChart', [trace], layout).then(() => {
                updateDebug('Chart rendered successfully');
                console.log('Chart rendered');
            }).catch(err => {
                console.error('Plotly render error:', err);
                showError('Chart rendering failed: ' + err.message);
                // Show fallback data if Plotly fails
                document.getElementById('fallbackData').style.display = 'block';
                document.getElementById('rawData').textContent = JSON.stringify(data.slice(0, 10), null, 2);
            });

            document.getElementById('pcaChart').on('plotly_click', function(data) {
                const point = data.points[0];
                const index = point.pointNumber;
                document.getElementById('custId').textContent = data[index].CUST_ID || 'N/A';
                document.getElementById('balance').textContent = `$${data[index].BALANCE.toFixed(2)}` || 'N/A';
                document.getElementById('purchases').textContent = `$${data[index].PURCHASES.toFixed(2)}` || 'N/A';
                document.getElementById('creditUsage').textContent = `${data[index].CREDIT_USAGE_RATIO.toFixed(2)}` || 'N/A';
                document.getElementById('cluster').textContent = data[index].Cluster || 'N/A';
                console.log('Clicked point:', index, data[index]);
            });
        }).catch(error => {
            console.error('CSV load error:', error);
            showError('Failed to load CSV: ' + error.message);
            updateDebug('Check console for details');
        });
    </script>
</body>
</html>